language: c
sudo: required
services:
  - docker

global:
  # It fixes failed to install Linuxbrew on Travis-CI
  # SEE: https://stackoverflow.com/a/48398032/1545387
  - HOMEBREW_FORCE_VENDOR_RUBY=1

cache:
  directories:
    - ~/.docker_imgs
    - ./gh-pages

jobs:
  include:
    - stage: build
      script:
        - docker build -t yap.sh-ubuntu:16.04 docker --build-arg UBUNTU_VERSION=16.04
        - docker build -t yap.sh-ubuntu:18.04 docker --build-arg UBUNTU_VERSION=18.04
        - mkdir -p ~/.docker_imgs
        - docker images -a --filter='dangling=false' --format '{{.Repository}}:{{.Tag}} {{.ID}}' | xargs -n 2 -t sh -c 'test -e ~/.docker_imgs/$1.tar.gz || docker save $0 | gzip -2 > ~/.docker_imgs/$1.tar.gz'
        - ./build.sh

    - &test
      stage: test
      script:
        - if [[ -d ~/.docker_imgs ]]; then ls ~/.docker_imgs/*.tar.gz | xargs -I {file} sh -c "zcat {file} | docker load"; fi
        - docker run -it --name yap.sh -v "$PWD/gh-pages/index.html:/yap.sh" "$IMAGE" /yap.sh
      env: IMAGE="yap.sh-ubuntu:16.04"

    - <<: *test
      env: IMAGE="yap.sh-ubuntu:18.04"

    - stage: Coverage check
      script: ./coverage.sh

    - stage: deploy
      local-dir: "./gh-pages"
      provider: pages
      github-token: $GITHUB_TOKEN
      name: Chanwoong Kim
      email: chanwoong@chanwoong.kim
      on:
        branch: master
